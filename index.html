<!DOCTYPE html>
<html lang="en">
<head>
  <meta property="og:image" content="https://corvid-agent.github.io/nft-gallery/docs/preview.png">
  <meta property="og:image:width" content="1280">
  <meta property="og:image:height" content="640">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Algorand NFT Gallery</title>
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg: #08080f;
  --card-bg: #12121a;
  --card-border: #1e1e2e;
  --accent-purple: #8b5cf6;
  --accent-cyan: #06b6d4;
  --text: #e8e8f0;
  --dim: #6b6b80;
  --font: system-ui, -apple-system, sans-serif;
  --radius-card: 12px;
  --radius-btn: 8px;
}

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  line-height: 1.6;
}

a {
  color: var(--accent-cyan);
  text-decoration: none;
  transition: color 0.2s;
}

a:hover {
  color: var(--accent-purple);
}

/* NAV */
nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--card-border);
  background: var(--card-bg);
  position: sticky;
  top: 0;
  z-index: 100;
}

nav .logo {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

nav .logo span.icon {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 1.6rem;
}

nav .nav-links {
  display: flex;
  gap: 20px;
  align-items: center;
}

nav .nav-links a {
  color: var(--dim);
  font-size: 0.9rem;
  font-weight: 500;
  transition: color 0.2s;
}

nav .nav-links a:hover {
  color: var(--text);
}

/* MAIN */
main {
  flex: 1;
  max-width: 1280px;
  width: 100%;
  margin: 0 auto;
  padding: 32px 24px;
}

/* HERO SEARCH */
.hero {
  text-align: center;
  padding: 40px 0 32px;
}

.hero h1 {
  font-size: 2.2rem;
  font-weight: 800;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero p {
  color: var(--dim);
  font-size: 1.05rem;
  margin-bottom: 28px;
}

.search-container {
  display: flex;
  gap: 12px;
  max-width: 680px;
  margin: 0 auto;
}

.search-container input {
  flex: 1;
  padding: 14px 18px;
  border-radius: var(--radius-btn);
  border: 1px solid var(--card-border);
  background: var(--card-bg);
  color: var(--text);
  font-size: 1rem;
  font-family: var(--font);
  outline: none;
  transition: border-color 0.2s;
}

.search-container input::placeholder {
  color: var(--dim);
}

.search-container input:focus {
  border-color: var(--accent-purple);
}

.search-container button {
  padding: 14px 28px;
  border-radius: var(--radius-btn);
  border: none;
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  font-family: var(--font);
  cursor: pointer;
  transition: opacity 0.2s, transform 0.2s;
  white-space: nowrap;
}

.search-container button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* SECTION HEADINGS */
.section-heading {
  font-size: 1.4rem;
  font-weight: 700;
  margin: 40px 0 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-heading .line {
  flex: 1;
  height: 1px;
  background: var(--card-border);
}

/* FEATURED COLLECTIONS */
.collections-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.collection-card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-card);
  padding: 20px;
  cursor: pointer;
  transition: transform 0.25s, box-shadow 0.25s, border-color 0.25s;
  text-align: center;
}

.collection-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 24px rgba(139, 92, 246, 0.15);
  border-color: var(--accent-purple);
}

.collection-card .collection-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.6rem;
  margin: 0 auto 12px;
}

.collection-card h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.collection-card p {
  color: var(--dim);
  font-size: 0.8rem;
  word-break: break-all;
}

/* NFT GRID */
.nft-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.nft-card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-card);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s, box-shadow 0.25s;
  position: relative;
}

.nft-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(139, 92, 246, 0.18);
}

.nft-card .image-wrapper {
  width: 100%;
  aspect-ratio: 1;
  background: #0a0a12;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.nft-card .image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.nft-card:hover .image-wrapper img {
  transform: scale(1.03);
}

.nft-card .image-wrapper .placeholder {
  color: var(--dim);
  font-size: 2.5rem;
}

.nft-card .fav-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(8, 8, 15, 0.7);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--dim);
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s, background 0.2s;
  z-index: 5;
}

.nft-card .fav-btn:hover,
.nft-card .fav-btn.active {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.15);
}

.nft-card .card-info {
  padding: 14px 16px;
}

.nft-card .card-info .nft-name {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.nft-card .card-info .nft-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nft-card .card-info .unit-name {
  color: var(--accent-cyan);
  font-size: 0.8rem;
  font-weight: 500;
}

.nft-card .card-info .asset-id {
  color: var(--dim);
  font-size: 0.75rem;
}

/* LOAD MORE */
.load-more-container {
  text-align: center;
  padding: 20px 0 40px;
}

.load-more-btn {
  padding: 12px 36px;
  border-radius: var(--radius-btn);
  border: 1px solid var(--accent-purple);
  background: transparent;
  color: var(--accent-purple);
  font-size: 0.95rem;
  font-weight: 600;
  font-family: var(--font);
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.load-more-btn:hover {
  background: var(--accent-purple);
  color: #fff;
}

.load-more-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* STATUS */
.status-msg {
  text-align: center;
  color: var(--dim);
  padding: 40px 20px;
  font-size: 1rem;
}

.status-msg.error {
  color: #ef4444;
}

.spinner {
  display: inline-block;
  width: 28px;
  height: 28px;
  border: 3px solid var(--card-border);
  border-top-color: var(--accent-purple);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.modal {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-card);
  max-width: 720px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  transform: scale(0.95);
  transition: transform 0.25s;
}

.modal-overlay.active .modal {
  transform: scale(1);
}

.modal-close {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--card-border);
  color: var(--dim);
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  transition: color 0.2s, background 0.2s;
}

.modal-close:hover {
  color: var(--text);
  background: rgba(255,255,255,0.1);
}

.modal .modal-image {
  width: 100%;
  max-height: 420px;
  object-fit: contain;
  background: #0a0a12;
  display: block;
  border-radius: var(--radius-card) var(--radius-card) 0 0;
}

.modal .modal-body {
  padding: 24px;
}

.modal .modal-body h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.modal .modal-body .modal-unit {
  color: var(--accent-cyan);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 16px;
}

.modal .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.modal .detail-item {
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-btn);
  padding: 12px;
}

.modal .detail-item .label {
  color: var(--dim);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 4px;
}

.modal .detail-item .value {
  font-size: 0.9rem;
  word-break: break-all;
}

.modal .traits-heading {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 12px;
}

.modal .traits-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.modal .trait-badge {
  background: rgba(139, 92, 246, 0.08);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: var(--radius-btn);
  padding: 10px 12px;
  text-align: center;
}

.modal .trait-badge .trait-type {
  color: var(--accent-purple);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 2px;
}

.modal .trait-badge .trait-value {
  font-size: 0.85rem;
  font-weight: 600;
}

.modal .description {
  color: var(--dim);
  font-size: 0.9rem;
  line-height: 1.7;
  margin-bottom: 16px;
}

/* FAVORITES TAB */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}

.tab-btn {
  padding: 8px 20px;
  border-radius: var(--radius-btn);
  border: 1px solid var(--card-border);
  background: transparent;
  color: var(--dim);
  font-size: 0.9rem;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
}

.tab-btn:hover {
  border-color: var(--accent-purple);
  color: var(--text);
}

.tab-btn.active {
  background: var(--accent-purple);
  border-color: var(--accent-purple);
  color: #fff;
}

/* FOOTER */
footer {
  border-top: 1px solid var(--card-border);
  background: var(--card-bg);
  padding: 24px;
  text-align: center;
}

footer p {
  color: var(--dim);
  font-size: 0.85rem;
  margin-bottom: 8px;
}

footer .footer-links {
  display: flex;
  gap: 20px;
  justify-content: center;
}

footer .footer-links a {
  color: var(--dim);
  font-size: 0.85rem;
  transition: color 0.2s;
}

footer .footer-links a:hover {
  color: var(--accent-cyan);
}

/* RESPONSIVE */
@media (max-width: 640px) {
  .hero h1 { font-size: 1.6rem; }
  .search-container { flex-direction: column; }
  .nft-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
  .collections-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
  .modal .detail-grid { grid-template-columns: 1fr; }
  nav { padding: 12px 16px; }
  nav .nav-links { gap: 12px; }
  nav .nav-links a { font-size: 0.8rem; }
  main { padding: 20px 16px; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--card-border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--dim); }
</style>
</head>
<body>

<nav>
  <a href="#" class="logo">
    <span class="icon">&#9670;</span> NFT Gallery
  </a>
  <div class="nav-links">
    <a href="https://corvid-agent.github.io/agent-dashboard/">Dashboard</a>
    <a href="https://corvid-agent.github.io/apps/">Apps</a>
    <a href="https://github.com/corvid-agent/nft-gallery">GitHub</a>
  </div>
</nav>

<main>
  <div class="hero">
    <h1>Algorand NFT Gallery</h1>
    <p>Browse, explore, and favorite NFTs on the Algorand blockchain</p>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Enter Algorand address or asset ID..." />
      <button id="searchBtn" onclick="handleSearch()">Search</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="browse" onclick="switchTab('browse')">Browse</button>
    <button class="tab-btn" data-tab="favorites" onclick="switchTab('favorites')">Favorites</button>
  </div>

  <div id="browseTab">
    <div id="featuredSection">
      <div class="section-heading">
        <span>Featured Collections</span>
        <div class="line"></div>
      </div>
      <div class="collections-grid" id="collectionsGrid"></div>
    </div>

    <div id="resultsSection" style="display:none;">
      <div class="section-heading">
        <span id="resultsHeading">Results</span>
        <div class="line"></div>
      </div>
      <div class="nft-grid" id="nftGrid"></div>
      <div id="statusArea"></div>
      <div class="load-more-container" id="loadMoreContainer" style="display:none;">
        <button class="load-more-btn" id="loadMoreBtn" onclick="loadMore()">Load More</button>
      </div>
    </div>
  </div>

  <div id="favoritesTab" style="display:none;">
    <div class="section-heading">
      <span>Your Favorites</span>
      <div class="line"></div>
    </div>
    <div class="nft-grid" id="favGrid"></div>
    <div id="favStatus"></div>
  </div>
</main>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <button class="modal-close" onclick="closeModalDirect()">&times;</button>
    <div id="modalContent"></div>
  </div>
</div>

<footer>
  <p>Built autonomously by corvid-agent</p>
  <div class="footer-links">
    <a href="https://github.com/corvid-agent/nft-gallery">GitHub</a>
    <a href="https://corvid-agent.github.io/">Landing Page</a>
    <a href="https://discord.gg/mQGPQy5fnd">Discord</a>
  </div>
</footer>

<script>
// ============================
// STATE
// ============================
const INDEXER = 'https://mainnet-idx.4160.nodely.dev';
const IPFS_GATEWAY = 'https://ipfs.io/ipfs/';

let state = {
  currentAddress: null,
  currentAssetId: null,
  assets: [],
  nextToken: null,
  loading: false,
  favorites: JSON.parse(localStorage.getItem('nft-favorites') || '{}'),
  cache: {} // asset id -> full data with arc69
};

// ============================
// FEATURED COLLECTIONS
// ============================
const FEATURED = [
  { name: 'Nevermore', address: 'WGSHC4TYKYBS6EX5V5E377BQDLKWIIPBCFOLZQZIXCKHFIEKRPBFOMW25A', icon: '\u{1F986}' },
  { name: 'Alchemon', address: 'OJGTHEJ2O5NXN7FVXDZZEEJTUEQHHCIYIE5MWY6BEFVVLZ2KANJODBOKGA', icon: '\u{1F409}' },
  { name: 'Al Goanna', address: 'D5J7H7PIYKLY2U6A5OFUAC7GQHTHSXXNX65DSD3CJYPBV2MVK6NTNW44CA', icon: '\u{1F98E}' },
  { name: 'Shitty Kitties', address: 'KPK5CEWRXZAHJLLK6ZAG5K3PGLY6ZEJREBOVVFXWYWEYGINUZY5IT3GG3I', icon: '\u{1F431}' },
  { name: 'Yieldlings', address: '5DYIZMX7N4SAB44HLVRUGLYBPSN4UMPDZVTX7V73AIRMJQA3LKTENTLFZ4', icon: '\u{1F331}' },
];

function renderFeatured() {
  const grid = document.getElementById('collectionsGrid');
  grid.innerHTML = FEATURED.map(c => `
    <div class="collection-card" onclick="browseCollection('${c.address}', '${c.name}')">
      <div class="collection-icon">${c.icon}</div>
      <h3>${c.name}</h3>
      <p>${c.address.slice(0, 8)}...${c.address.slice(-6)}</p>
    </div>
  `).join('');
}

// ============================
// IPFS URL RESOLUTION
// ============================
function resolveUrl(url) {
  if (!url) return null;
  url = url.trim();

  // ARC-19 template-ipfs:// handling
  if (url.startsWith('template-ipfs://')) {
    const cid = parseArc19Url(url);
    if (cid) return IPFS_GATEWAY + cid;
    return null;
  }

  // Standard IPFS
  if (url.startsWith('ipfs://')) {
    return IPFS_GATEWAY + url.slice(7);
  }

  // Raw CID (starts with Qm or bafy)
  if (/^(Qm[1-9A-HJ-NP-Za-km-z]{44,}|bafy[a-z0-9]{50,})/.test(url)) {
    return IPFS_GATEWAY + url;
  }

  // Already an HTTP URL
  if (url.startsWith('http://') || url.startsWith('https://')) {
    // Replace known IPFS gateways if broken
    return url;
  }

  return url;
}

// ============================
// ARC-19 PARSING
// ============================
function parseArc19Url(url) {
  // template-ipfs://{ipfscid:version:codec:field_name:hash_type}
  // We extract the reserve address to CID approach
  // For simplicity, we parse what we can from the URL template
  // ARC-19 assets store the CID in the reserve address
  // The URL format: template-ipfs://{ipfscid:1:raw:reserve:sha2-256}
  // or template-ipfs://{ipfscid:1:dag-pb:reserve:sha2-256}#arc3
  // This requires the reserve address to decode the CID
  // For now, return null â€” we'll resolve ARC-19 in the asset detail fetch
  return null;
}

function resolveArc19WithReserve(url, reserveAddress) {
  if (!url || !url.startsWith('template-ipfs://') || !reserveAddress) return null;
  try {
    // Parse template: template-ipfs://{ipfscid:VERSION:CODEC:FIELD:HASH}#fragment
    const match = url.match(/\{ipfscid:(\d+):([^:]+):([^:]+):([^}]+)\}/);
    if (!match) return null;
    const version = parseInt(match[1]);
    const codec = match[2];
    const hashType = match[4];

    // Decode Algorand address to get the 32-byte public key
    const decoded = decodeAlgorandAddress(reserveAddress);
    if (!decoded) return null;

    // Build CID from components
    const cid = encodeCidV1(decoded, version, codec, hashType);
    if (!cid) return null;

    // Check for fragment path
    let suffix = '';
    const hashIdx = url.indexOf('#');
    if (hashIdx !== -1) {
      suffix = url.substring(hashIdx);
    }
    // Check for path after the template part
    const closeBrace = url.indexOf('}');
    if (closeBrace !== -1 && closeBrace + 1 < url.length) {
      const afterBrace = url.substring(closeBrace + 1);
      if (afterBrace && !afterBrace.startsWith('#')) {
        suffix = afterBrace;
      }
    }

    return IPFS_GATEWAY + cid + (suffix && !suffix.startsWith('#') ? suffix : '');
  } catch (e) {
    console.warn('ARC-19 resolve error:', e);
    return null;
  }
}

// Decode Algorand base32 address to 32-byte public key
function decodeAlgorandAddress(address) {
  try {
    const decoded = base32Decode(address);
    // Algorand address = 32 bytes public key + 4 bytes checksum
    return decoded.slice(0, 32);
  } catch (e) {
    return null;
  }
}

// Base32 (RFC 4648) decoder
function base32Decode(input) {
  const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  input = input.replace(/=+$/, '').toUpperCase();
  const output = [];
  let bits = 0;
  let value = 0;
  for (let i = 0; i < input.length; i++) {
    const idx = ALPHABET.indexOf(input[i]);
    if (idx === -1) continue;
    value = (value << 5) | idx;
    bits += 5;
    if (bits >= 8) {
      output.push((value >>> (bits - 8)) & 0xff);
      bits -= 8;
    }
  }
  return new Uint8Array(output);
}

// Encode CIDv1 from 32-byte hash
function encodeCidV1(hash, version, codecName, hashType) {
  // CIDv1: <multibase><version><multicodec><multihash>
  // multibase: base32lower prefix 'b'
  // version: 0x01
  // multicodec: raw=0x55, dag-pb=0x70, dag-cbor=0x71
  // multihash: <hash-func-code><digest-size><digest>
  // sha2-256: 0x12, size: 0x20

  const codecMap = { 'raw': 0x55, 'dag-pb': 0x70, 'dag-cbor': 0x71 };
  const hashMap = { 'sha2-256': 0x12 };

  const codecCode = codecMap[codecName] || 0x55;
  const hashCode = hashMap[hashType] || 0x12;

  if (version === 0) {
    // CIDv0 is just the multihash, encoded as base58
    // For simplicity, convert to v1
    version = 1;
  }

  // Build the binary CID
  const parts = [];
  // Version varint
  parts.push(...encodeVarint(1));
  // Codec varint
  parts.push(...encodeVarint(codecCode));
  // Multihash: hash function code + digest size + digest
  parts.push(...encodeVarint(hashCode));
  parts.push(...encodeVarint(hash.length));
  parts.push(...hash);

  const cidBytes = new Uint8Array(parts);
  // Encode as base32lower with 'b' prefix
  return 'b' + base32Encode(cidBytes).toLowerCase();
}

function encodeVarint(value) {
  const bytes = [];
  while (value >= 0x80) {
    bytes.push((value & 0x7f) | 0x80);
    value >>>= 7;
  }
  bytes.push(value & 0x7f);
  return bytes;
}

function base32Encode(data) {
  const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let result = '';
  let bits = 0;
  let value = 0;
  for (let i = 0; i < data.length; i++) {
    value = (value << 8) | data[i];
    bits += 8;
    while (bits >= 5) {
      result += ALPHABET[(value >>> (bits - 5)) & 0x1f];
      bits -= 5;
    }
  }
  if (bits > 0) {
    result += ALPHABET[(value << (5 - bits)) & 0x1f];
  }
  return result;
}

// ============================
// API FUNCTIONS
// ============================
async function fetchCreatedAssets(address, limit = 20, nextToken = null) {
  let url = `${INDEXER}/v2/accounts/${address}/created-assets?limit=${limit}`;
  if (nextToken) url += `&next=${nextToken}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`API error: ${resp.status}`);
  const data = await resp.json();
  return {
    assets: data.assets || [],
    nextToken: data['next-token'] || null
  };
}

async function fetchAssetDetail(assetId) {
  const url = `${INDEXER}/v2/assets/${assetId}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Asset not found: ${resp.status}`);
  const data = await resp.json();
  return data.asset;
}

async function fetchArc69Metadata(assetId) {
  const url = `${INDEXER}/v2/assets/${assetId}/transactions?tx-type=acfg`;
  try {
    const resp = await fetch(url);
    if (!resp.ok) return null;
    const data = await resp.json();
    const txns = data.transactions || [];
    if (txns.length === 0) return null;

    const tx = txns[txns.length - 1];
    const note = tx.note;
    if (!note) return null;

    // Base64 decode
    const decoded = atob(note);
    // Try to parse as JSON (ARC-69)
    try {
      const json = JSON.parse(decoded);
      if (json.standard === 'arc69' || json.properties || json.attributes || json.description) {
        return json;
      }
      return json;
    } catch {
      return null;
    }
  } catch {
    return null;
  }
}

// ============================
// IMAGE URL RESOLUTION FOR ASSETS
// ============================
function getImageUrl(asset, arc69) {
  const params = asset.params || asset;

  // Try ARC-19 first (template-ipfs:// in URL with reserve address)
  if (params.url && params.url.startsWith('template-ipfs://')) {
    const reserve = params.reserve || params['reserve-address'];
    if (reserve) {
      const resolved = resolveArc19WithReserve(params.url, reserve);
      if (resolved) return resolved;
    }
  }

  // ARC-69 metadata image
  if (arc69) {
    if (arc69.image) return resolveUrl(arc69.image);
    if (arc69.image_url) return resolveUrl(arc69.image_url);
    if (arc69.animation_url) return resolveUrl(arc69.animation_url);
  }

  // Standard URL field
  if (params.url) {
    const resolved = resolveUrl(params.url);
    if (resolved) return resolved;
  }

  return null;
}

// ============================
// FAVORITES
// ============================
function isFavorite(assetId) {
  return !!state.favorites[assetId];
}

function toggleFavorite(assetId, assetData, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  if (state.favorites[assetId]) {
    delete state.favorites[assetId];
  } else {
    state.favorites[assetId] = assetData;
  }
  localStorage.setItem('nft-favorites', JSON.stringify(state.favorites));
  refreshFavButtons();
  if (document.getElementById('favoritesTab').style.display !== 'none') {
    renderFavorites();
  }
}

function refreshFavButtons() {
  document.querySelectorAll('.fav-btn').forEach(btn => {
    const id = btn.dataset.assetId;
    if (isFavorite(id)) {
      btn.classList.add('active');
      btn.innerHTML = '&#9829;';
    } else {
      btn.classList.remove('active');
      btn.innerHTML = '&#9825;';
    }
  });
}

// ============================
// RENDERING
// ============================
function renderNftCard(asset, container) {
  const params = asset.params || asset;
  const assetId = asset.index || asset['asset-id'] || asset.id;
  const name = params.name || params['unit-name'] || `Asset #${assetId}`;
  const unitName = params['unit-name'] || '';
  const imageUrl = getImageUrl(asset, state.cache[assetId]?.arc69);

  const card = document.createElement('div');
  card.className = 'nft-card';
  card.onclick = () => openDetail(assetId, asset);

  const favActive = isFavorite(assetId) ? 'active' : '';
  const favIcon = isFavorite(assetId) ? '&#9829;' : '&#9825;';

  card.innerHTML = `
    <div class="image-wrapper">
      ${imageUrl
        ? `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(name)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>&#9670;</div>'" />`
        : `<div class="placeholder">&#9670;</div>`
      }
      <button class="fav-btn ${favActive}" data-asset-id="${assetId}" onclick="toggleFavorite('${assetId}', ${escapeAttr(JSON.stringify({index: assetId, params}))}, event)">${favIcon}</button>
    </div>
    <div class="card-info">
      <div class="nft-name">${escapeHtml(name)}</div>
      <div class="nft-meta">
        <span class="unit-name">${escapeHtml(unitName)}</span>
        <span class="asset-id">#${assetId}</span>
      </div>
    </div>
  `;

  container.appendChild(card);
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function escapeAttr(str) {
  return str.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function showStatus(msg, isError = false) {
  const el = document.getElementById('statusArea');
  if (msg === 'loading') {
    el.innerHTML = '<div class="status-msg"><div class="spinner"></div></div>';
  } else if (msg) {
    el.innerHTML = `<div class="status-msg ${isError ? 'error' : ''}">${escapeHtml(msg)}</div>`;
  } else {
    el.innerHTML = '';
  }
}

// ============================
// SEARCH & BROWSE
// ============================
async function handleSearch() {
  const input = document.getElementById('searchInput').value.trim();
  if (!input) return;

  // Reset state
  state.assets = [];
  state.nextToken = null;
  state.currentAddress = null;
  state.currentAssetId = null;

  const grid = document.getElementById('nftGrid');
  grid.innerHTML = '';
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('loadMoreContainer').style.display = 'none';

  // Determine if it's an asset ID or address
  if (/^\d+$/.test(input)) {
    // Asset ID
    document.getElementById('resultsHeading').textContent = `Asset #${input}`;
    showStatus('loading');
    try {
      const asset = await fetchAssetDetail(input);
      const arc69 = await fetchArc69Metadata(input);
      state.cache[input] = { asset, arc69 };
      showStatus('');
      renderNftCard(asset, grid);
    } catch (e) {
      showStatus(e.message, true);
    }
  } else {
    // Address
    state.currentAddress = input;
    document.getElementById('resultsHeading').textContent = `Assets by ${input.slice(0, 8)}...${input.slice(-6)}`;
    await loadAssets();
  }
}

async function browseCollection(address, name) {
  document.getElementById('searchInput').value = address;
  state.assets = [];
  state.nextToken = null;
  state.currentAddress = address;
  state.currentAssetId = null;

  const grid = document.getElementById('nftGrid');
  grid.innerHTML = '';
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('resultsHeading').textContent = name || `Assets by ${address.slice(0, 8)}...`;
  document.getElementById('loadMoreContainer').style.display = 'none';

  // Scroll to results
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

  await loadAssets();
}

async function loadAssets() {
  if (state.loading || !state.currentAddress) return;
  state.loading = true;
  showStatus('loading');
  document.getElementById('loadMoreBtn').disabled = true;

  try {
    const result = await fetchCreatedAssets(state.currentAddress, 20, state.nextToken);
    state.nextToken = result.nextToken;
    state.assets.push(...result.assets);

    const grid = document.getElementById('nftGrid');
    showStatus('');

    if (result.assets.length === 0 && state.assets.length === 0) {
      showStatus('No assets found for this address.');
    } else {
      // Fetch ARC-69 metadata for each asset in parallel (batch)
      const promises = result.assets.map(async (a) => {
        const id = a.index;
        if (!state.cache[id]) {
          const arc69 = await fetchArc69Metadata(id).catch(() => null);
          state.cache[id] = { asset: a, arc69 };
        }
        renderNftCard(a, grid);
      });
      await Promise.all(promises);

      if (state.nextToken) {
        document.getElementById('loadMoreContainer').style.display = 'block';
      } else {
        document.getElementById('loadMoreContainer').style.display = 'none';
      }
    }
  } catch (e) {
    showStatus(e.message, true);
  }

  state.loading = false;
  document.getElementById('loadMoreBtn').disabled = false;
}

async function loadMore() {
  await loadAssets();
}

// ============================
// DETAIL MODAL
// ============================
async function openDetail(assetId, asset) {
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');

  content.innerHTML = '<div class="status-msg"><div class="spinner"></div></div>';
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';

  try {
    // Fetch full detail if we don't have it
    let fullAsset = asset;
    if (!asset.params && !asset['params']) {
      fullAsset = await fetchAssetDetail(assetId);
    }

    let arc69 = state.cache[assetId]?.arc69;
    if (arc69 === undefined) {
      arc69 = await fetchArc69Metadata(assetId);
      state.cache[assetId] = { asset: fullAsset, arc69 };
    }

    const params = fullAsset.params || fullAsset;
    const name = params.name || params['unit-name'] || `Asset #${assetId}`;
    const unitName = params['unit-name'] || '';
    const creator = params.creator || '';
    const total = params.total || 0;
    const decimals = params.decimals || 0;
    const url = params.url || '';
    const reserve = params.reserve || '';
    const imageUrl = getImageUrl(fullAsset, arc69);

    // Traits
    let traits = [];
    if (arc69) {
      if (arc69.properties) {
        traits = Object.entries(arc69.properties).map(([k, v]) => ({ trait_type: k, value: v }));
      } else if (arc69.attributes && Array.isArray(arc69.attributes)) {
        traits = arc69.attributes;
      }
    }

    const description = arc69?.description || '';

    content.innerHTML = `
      ${imageUrl
        ? `<img class="modal-image" src="${escapeHtml(imageUrl)}" alt="${escapeHtml(name)}" onerror="this.style.display='none'" />`
        : ''
      }
      <div class="modal-body">
        <h2>${escapeHtml(name)}</h2>
        ${unitName ? `<div class="modal-unit">${escapeHtml(unitName)}</div>` : ''}
        ${description ? `<div class="description">${escapeHtml(description)}</div>` : ''}

        <div class="detail-grid">
          <div class="detail-item">
            <div class="label">Asset ID</div>
            <div class="value">${assetId}</div>
          </div>
          <div class="detail-item">
            <div class="label">Total Supply</div>
            <div class="value">${total.toLocaleString()}${decimals > 0 ? ` (${decimals} decimals)` : ''}</div>
          </div>
          <div class="detail-item">
            <div class="label">Creator</div>
            <div class="value">${creator ? creator.slice(0, 12) + '...' + creator.slice(-8) : 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="label">URL</div>
            <div class="value" style="font-size:0.8rem;">${url ? escapeHtml(url.slice(0, 50)) + (url.length > 50 ? '...' : '') : 'N/A'}</div>
          </div>
          ${reserve ? `
          <div class="detail-item">
            <div class="label">Reserve</div>
            <div class="value">${reserve.slice(0, 12)}...${reserve.slice(-8)}</div>
          </div>` : ''}
          ${arc69?.standard ? `
          <div class="detail-item">
            <div class="label">Standard</div>
            <div class="value">${escapeHtml(arc69.standard)}</div>
          </div>` : ''}
        </div>

        ${traits.length > 0 ? `
          <div class="traits-heading">Traits</div>
          <div class="traits-grid">
            ${traits.map(t => `
              <div class="trait-badge">
                <div class="trait-type">${escapeHtml(String(t.trait_type || t.type || 'Trait'))}</div>
                <div class="trait-value">${escapeHtml(String(t.value))}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  } catch (e) {
    content.innerHTML = `<div class="modal-body"><div class="status-msg error">${escapeHtml(e.message)}</div></div>`;
  }
}

function closeModal(event) {
  if (event.target === document.getElementById('modalOverlay')) {
    closeModalDirect();
  }
}

function closeModalDirect() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

// ============================
// TABS
// ============================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');

  if (tab === 'browse') {
    document.getElementById('browseTab').style.display = '';
    document.getElementById('favoritesTab').style.display = 'none';
  } else {
    document.getElementById('browseTab').style.display = 'none';
    document.getElementById('favoritesTab').style.display = '';
    renderFavorites();
  }
}

function renderFavorites() {
  const grid = document.getElementById('favGrid');
  const status = document.getElementById('favStatus');
  grid.innerHTML = '';
  status.innerHTML = '';

  const favIds = Object.keys(state.favorites);
  if (favIds.length === 0) {
    status.innerHTML = '<div class="status-msg">No favorites yet. Click the heart on any NFT to save it.</div>';
    return;
  }

  favIds.forEach(id => {
    const data = state.favorites[id];
    if (data) {
      renderNftCard(data, grid);
    }
  });
}

// ============================
// KEYBOARD SHORTCUTS
// ============================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModalDirect();
  }
  if (e.key === 'Enter' && document.activeElement === document.getElementById('searchInput')) {
    handleSearch();
  }
});

// ============================
// INIT
// ============================
renderFeatured();
</script>
</body>
</html>
